<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Contratos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); display: none; }
        .modal-backdrop.flex { display: flex; }
        .modal-content { max-height: 90vh; overflow-y: auto; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        /* Estilo para a barra de rolagem da trilha de auditoria */
        #audit-trail-list::-webkit-scrollbar { width: 8px; }
        #audit-trail-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        #audit-trail-list::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        #audit-trail-list::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- TELA DE LOGIN -->
    <div id="auth-view" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <form id="login-form">
                <h2 class="text-2xl font-bold text-center text-gray-700">Login</h2>
                <div id="login-error" class="hidden p-3 mt-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                <div class="mt-4 space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    <input type="password" id="login-password" placeholder="Senha" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 mt-6 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">Entrar</button>
                <p id="register-link-container" class="mt-4 text-sm text-center text-gray-600">
                    Primeiro acesso? <a href="#" id="show-register" class="font-medium text-blue-600 hover:underline">Crie a conta de Admin</a>
                </p>
            </form>
            <form id="register-form" class="hidden">
                 <h2 class="text-2xl font-bold text-center text-gray-700">Cadastro do Administrador</h2>
                 <div id="register-error" class="hidden p-3 mt-4 text-sm text-red-700 bg-red-100 rounded-lg"></div>
                <div class="mt-4 space-y-4">
                     <input type="email" id="register-email" placeholder="Email para o Admin" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                     <input type="password" id="register-password" placeholder="Senha para o Admin" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <button type="submit" class="w-full px-4 py-2 mt-6 font-bold text-white bg-blue-600 rounded-md hover:bg-blue-700">Criar Conta Admin</button>
                <p class="mt-4 text-sm text-center text-gray-600">
                    Já tem uma conta? <a href="#" id="show-login" class="font-medium text-blue-600 hover:underline">Faça Login</a>
                </p>
            </form>
        </div>
    </div>

    <!-- TELA PRINCIPAL DA APLICAÇÃO -->
    <div id="app-view" class="hidden">
        <div class="container mx-auto p-4 sm:p-6 lg:p-8">
            <header class="flex flex-col sm:flex-row justify-between items-center mb-6">
                 <div class="flex flex-col items-start">
                     <h1 class="text-3xl font-bold text-gray-700">
                         <i class="fas fa-file-signature mr-2"></i>Gerenciador de Contratos
                     </h1>
                     <p id="user-email" class="text-sm text-gray-500 mt-1"></p>
                 </div>
                <div class="flex items-center mt-4 sm:mt-0">
                    <button id="report-btn" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-4">
                        <i class="fas fa-print mr-2"></i>Gerar Relatório
                    </button>
                    <button id="create-user-btn" class="hidden bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-4">
                        <i class="fas fa-user-plus mr-2"></i>Criar Usuário
                    </button>
                    <button id="addContractBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 mr-4">
                        <i class="fas fa-plus mr-2"></i>Adicionar Contrato
                    </button>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        <i class="fas fa-sign-out-alt mr-2"></i>Sair
                    </button>
                </div>
            </header>
            
            <div id="main-content">
                <div class="mb-8 bg-white p-4 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <i class="fas fa-search text-gray-400"></i>
                                </div>
                                <input type="text" id="search-input" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar por título ou parte...">
                            </div>
                        </div>
                        <div>
                            <select id="filter-process-status" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">Todos os Status</option>
                                <option>Proposta Registrada</option>
                                <option>Documentação Validada</option>
                                <option>Pagamento Validado</option>
                                <option>Pronta para Assinatura</option>
                                <option>Contrato Assinado e Concluído</option>
                            </select>
                        </div>
                        <div>
                            <select id="filter-cost-center" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="all">Todos os C. de Custo</option>
                                <option>Institucional</option>
                                <option>Cidade do Samba</option>
                                <option>Custeio</option>
                            </select>
                        </div>
                         <div class="md:col-span-1">
                             <select id="filter-sector" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                 <option value="all">Todos os Setores</option>
                                 <option>RH</option><option>Administração</option><option>Impostos</option><option>Manutenção</option><option>Operacional</option><option>Jurídico</option><option>Cultural</option><option>Comercial/Institucional</option><option>Infraestrutura</option><option>Julgadores</option><option>Logística</option><option>Marketing</option><option>Comunicação</option><option>Pista</option><option>Produção</option><option>Produção - Setor 4</option><option>Eventos</option><option>Contrapartidas</option><option>Ensaios Técnicos</option>
                             </select>
                         </div>
                    </div>
                </div>

                <main id="contract-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></main>
                <div id="loading-message" class="text-center py-10">
                    <p class="text-gray-500 text-lg">Carregando...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CRIAR USUÁRIO -->
    <div id="create-user-modal" class="modal-backdrop fixed inset-0 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md mx-4 p-6 relative animate-fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Criar Novo Usuário</h2>
            <form id="create-user-form">
                <div id="create-user-feedback" class="hidden p-3 mb-4 text-sm rounded-lg"></div>
                <div class="space-y-4">
                    <input type="email" id="new-user-email" placeholder="Email do novo usuário" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    <input type="password" id="new-user-password" placeholder="Senha provisória (mínimo 6 caracteres)" class="w-full px-3 py-2 border border-gray-300 rounded-md" required minlength="6">
                    <select id="new-user-role" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md" required>
                        <option value="" disabled selected>Selecione a Função</option>
                        <option value="Registra Proposta">1 - Registra Proposta</option>
                        <option value="Valida Documentos">2 - Valida os documentos da proposta (Janaina)</option>
                        <option value="Valida Pagamento">3 - Valida o fluxo de pagamento (Financeiro)</option>
                        <option value="Valida Assinatura">4 - Valida a proposta para assinatura (Presidente)</option>
                        <option value="Assina Minuta">5 - Assina a Minuta (Jurídico)</option>
                        <option value="Presidente">Presidente (Acesso Total)</option>
                        <option value="admin">Admin (Acesso Total)</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" id="cancel-create-user-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md">Criar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DE CONTRATO (com Trilha de Auditoria) -->
    <div id="contract-modal" class="modal-backdrop fixed inset-0 items-center justify-center z-40">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl mx-4 p-6 relative animate-fade-in modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6 text-gray-700">Adicionar Novo Contrato</h2>
            <form id="contract-form">
                <input type="hidden" id="contract-id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div class="md:col-span-2"><label for="title" class="block text-sm font-medium text-gray-600 mb-1">Título do Contrato</label><input type="text" id="title" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    
                    <div class="md:col-span-2">
                        <label for="status" class="block text-sm font-medium text-gray-600 mb-1">Status do Processo</label>
                        <select id="status" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md" required>
                            <option>Proposta Registrada</option>
                            <option>Documentação Validada</option>
                            <option>Pagamento Validado</option>
                            <option>Pronta para Assinatura</option>
                            <option>Contrato Assinado e Concluído</option>
                        </select>
                        <div id="modal-actions-container" class="mt-4 space-x-2"></div>
                    </div>

                    <div><label for="service_type" class="block text-sm font-medium text-gray-600 mb-1">Tipo de Serviço</label><input type="text" id="service_type" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Show, Consultoria, etc."></div>
                    <div><label for="party" class="block text-sm font-medium text-gray-600 mb-1">Parte Contratada</label><input type="text" id="party" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="cost_center" class="block text-sm font-medium text-gray-600 mb-1">Centro de Custos</label><select id="cost_center" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md" required><option>Institucional</option><option>Cidade do Samba</option><option>Custeio</option></select></div>
                    <div><label for="sector" class="block text-sm font-medium text-gray-600 mb-1">Setor</label><select id="sector" class="w-full bg-white px-3 py-2 border border-gray-300 rounded-md" required><option>RH</option><option>Administração</option><option>Impostos</option><option>Manutenção</option><option>Operacional</option><option>Jurídico</option><option>Cultural</option><option>Comercial/Institucional</option><option>Infraestrutura</option><option>Julgadores</option><option>Logística</option><option>Marketing</option><option>Comunicação</option><option>Pista</option><option>Produção</option><option>Produção - Setor 4</option><option>Eventos</option><option>Contrapartidas</option><option>Ensaios Técnicos</option></select></div>
                    <div><label for="value" class="block text-sm font-medium text-gray-600 mb-1">Valor (R$)</label><input type="number" step="0.01" id="value" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div>
                        <label for="installments-number" class="block text-sm font-medium text-gray-600 mb-1">Nº de Parcelas</label>
                        <input type="number" id="installments-number" class="w-full px-3 py-2 border border-gray-300 rounded-md" min="1" value="1">
                    </div>
                    <div><label for="start-date" class="block text-sm font-medium text-gray-600 mb-1">Início</label><input type="date" id="start-date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div><label for="end-date" class="block text-sm font-medium text-gray-600 mb-1">Término</label><input type="date" id="end-date" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></div>
                    <div id="installments-container" class="md:col-span-2 mt-2 space-y-4"></div>
                    <div class="md:col-span-2"><label for="observations" class="block text-sm font-medium text-gray-600 mb-1">Observações</label><textarea id="observations" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Ex: Falta assinatura do diretor financeiro..."></textarea></div>
                    <div class="md:col-span-2"><label for="document-files" class="block text-sm font-medium text-gray-600 mb-1">Anexar Documentos (PDF)</label>
                        <input type="file" id="document-files" accept=".pdf" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" multiple>
                        <div id="attachments-list" class="mt-4 space-y-2"></div>
                        <div id="staged-attachments-list" class="mt-2 space-y-2"></div>
                    </div>

                    <!-- NOVA SEÇÃO: TRILHA DE AUDITORIA -->
                    <div id="audit-trail-section" class="md:col-span-2 mt-6 pt-4 border-t border-gray-200 hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">
                            <i class="fas fa-history mr-2 text-gray-500"></i>Histórico de Alterações (Trilha de Auditoria)
                        </h3>
                        <div id="audit-trail-list" class="space-y-3 max-h-60 overflow-y-auto bg-gray-50 p-3 rounded-md">
                            <!-- Os logs de auditoria serão inseridos aqui pelo JavaScript -->
                        </div>
                    </div>
                </div>
                <div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-md">Cancelar</button><button type="submit" id="save-btn" class="px-6 py-2 bg-blue-600 text-white rounded-md flex items-center justify-center"><span id="save-btn-text">Salvar</span><i id="save-spinner" class="fas fa-spinner fa-spin hidden ml-2"></i></button></div>
            </form>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
    </div>
    
    <!-- MODAL DE ALERTA -->
    <div id="alert-modal" class="modal-backdrop fixed inset-0 items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-sm mx-4 p-6 relative animate-fade-in"><h3 id="alert-title" class="text-lg font-bold text-gray-800 mb-4"></h3><p id="alert-message" class="text-gray-600 mb-6"></p><div id="alert-buttons" class="flex justify-end space-x-4"></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, getDoc, addDoc, updateDoc, serverTimestamp, query, orderBy, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        document.addEventListener('DOMContentLoaded', () => {
            
            const firebaseConfig = {
              apiKey: "AIzaSyDY3qxKdbwBk56-cgB1TezEc9LSVqkdnAs",
              authDomain: "gerenciador-de-contratos-cbc47.firebaseapp.com",
              projectId: "gerenciador-de-contratos-cbc47",
              storageBucket: "gerenciador-de-contratos-cbc47.appspot.com",
              messagingSenderId: "544353319340",
              appId: "1:544353319340:web:070ac470eac63241f36209"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let currentUser = null;
            let userRole = null;
            let allContracts = [];
            let unsubscribeFromContracts = null;
            let unsubscribeFromAttachments = null;
            let unsubscribeFromAuditTrail = null; 
            let appListenersInitialized = false;

            const PROCESS_STATUS_STYLES = {
                'Proposta Registrada': { color: 'gray', icon: 'fa-pencil-alt' },
                'Documentação Validada': { color: 'cyan', icon: 'fa-file-circle-check' },
                'Pagamento Validado': { color: 'blue', icon: 'fa-hand-holding-dollar' },
                'Pronta para Assinatura': { color: 'indigo', icon: 'fa-stamp' },
                'Contrato Assinado e Concluído': { color: 'green', icon: 'fa-check-circle' }
            };

            async function callHttpsFunction(functionName, payload, region = 'southamerica-east1') {
                if (!currentUser) throw new Error("Usuário não autenticado.");
                const token = await currentUser.getIdToken(true);
                const projectId = firebaseConfig.projectId; 
                const url = `https://${region}-${projectId}.cloudfunctions.net/${functionName}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify({ data: payload })
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: { message: response.statusText } }));
                    throw new Error(errorData.error.message || 'Erro na chamada da função.');
                }
                const result = await response.json();
                return result.data;
            }

            function showAuthAlert(elId, message) {
                const errorEl = document.getElementById(elId);
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            
            function showAlert(title, message, buttons) {
                const alertModal = document.getElementById('alert-modal');
                alertModal.querySelector('#alert-title').textContent = title;
                alertModal.querySelector('#alert-message').textContent = message;
                const buttonsContainer = alertModal.querySelector('#alert-buttons');
                buttonsContainer.innerHTML = '';
                buttons.forEach(btn => {
                    const buttonEl = document.createElement('button');
                    buttonEl.textContent = btn.text;
                    buttonEl.className = btn.class;
                    buttonEl.onclick = () => {
                        alertModal.classList.remove('flex');
                        if(btn.onClick) btn.onClick();
                    };
                    buttonsContainer.appendChild(buttonEl);
                });
                alertModal.classList.add('flex');
            };

            onAuthStateChanged(auth, async (user) => {
                const authView = document.getElementById('auth-view');
                const appView = document.getElementById('app-view');
                
                if (user) {
                    currentUser = user;
                    try {
                        const roleDoc = await getDoc(doc(db, "userRoles", user.uid));
                        userRole = roleDoc.exists() ? roleDoc.data().role : null;
                        
                        authView.classList.remove('flex');
                        authView.classList.add('hidden');
                        appView.classList.remove('hidden');
                        
                        setupAppUI();
                        if (!appListenersInitialized) {
                            setupAppListeners();
                            appListenersInitialized = true;
                        }
                    } catch (error) {
                        console.error("Erro ao buscar dados do usuário:", error);
                        showAlert("Erro Crítico", "Não foi possível carregar os dados da sua conta.", []);
                        signOut(auth);
                    }
                } else {
                    currentUser = null;
                    userRole = null;
                    if (unsubscribeFromContracts) unsubscribeFromContracts();
                    if (unsubscribeFromAttachments) unsubscribeFromAttachments();
                    if (unsubscribeFromAuditTrail) unsubscribeFromAuditTrail();
                    appListenersInitialized = false;
                    
                    authView.classList.remove('hidden');
                    authView.classList.add('flex');
                    appView.classList.add('hidden');
                }
            });

            function setupAuthListeners() {
                const loginForm = document.getElementById('login-form');
                const registerForm = document.getElementById('register-form');
                document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); loginForm.classList.add('hidden'); registerForm.classList.remove('hidden'); });
                document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); registerForm.classList.add('hidden'); loginForm.classList.remove('hidden'); });
                
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        await signInWithEmailAndPassword(auth, loginForm['login-email'].value, loginForm['login-password'].value);
                    } catch (error) {
                        showAuthAlert('login-error', 'Email ou senha inválidos.');
                    }
                });
                
                registerForm.addEventListener('submit', handleRegisterFormSubmit);
                setupInitialAuthScreen();
            }

            function setupAppUI() {
                document.getElementById('user-email').textContent = `Logado como: ${currentUser.email} (${userRole || 'Sem Função'})`;
                if (userRole === 'admin') {
                    document.getElementById('create-user-btn').classList.remove('hidden');
                } else {
                    document.getElementById('create-user-btn').classList.add('hidden');
                }
            }

            function setupAppListeners() {
                document.getElementById('logoutBtn').onclick = () => signOut(auth);
                document.getElementById('addContractBtn').addEventListener('click', () => openContractModal('add'));
                document.getElementById('report-btn').addEventListener('click', generatePDFReport);
                document.getElementById('search-input').addEventListener('input', applyFiltersAndRender);
                document.getElementById('filter-process-status').addEventListener('change', applyFiltersAndRender);
                document.getElementById('filter-cost-center').addEventListener('change', applyFiltersAndRender);
                document.getElementById('filter-sector').addEventListener('change', applyFiltersAndRender);
                document.getElementById('contract-form').addEventListener('submit', handleContractFormSubmit);
                document.getElementById('cancel-btn').addEventListener('click', closeContractModal);
                document.getElementById('close-modal-btn').addEventListener('click', closeContractModal);
                const createUserModal = document.getElementById('create-user-modal');
                document.getElementById('create-user-btn').onclick = () => createUserModal.classList.add('flex');
                document.getElementById('cancel-create-user-btn').onclick = () => createUserModal.classList.remove('flex');
                document.getElementById('create-user-form').addEventListener('submit', handleCreateUserFormSubmit);
                
                const contractsQuery = query(collection(db, "sharedContracts"), orderBy("lastModifiedAt", "desc"));
                
                // *** ALTERAÇÃO AQUI: Carrega contratos e seus anexos juntos ***
                unsubscribeFromContracts = onSnapshot(contractsQuery, async (snapshot) => {
                    const contractsFromDB = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Para cada contrato, busca os seus anexos
                    allContracts = await Promise.all(contractsFromDB.map(async (contract) => {
                        const attachmentsQuery = query(collection(db, `sharedContracts/${contract.id}/anexos`), orderBy("uploadedAt"));
                        const attachmentsSnapshot = await getDocs(attachmentsQuery);
                        const attachments = attachmentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        return { ...contract, attachments }; // Adiciona os anexos ao objeto do contrato
                    }));

                    applyFiltersAndRender();
                    document.getElementById('loading-message').style.display = 'none';
                }, (error) => {
                    console.error("Erro no listener de contratos:", error);
                    document.getElementById('loading-message').innerHTML = `<p class="text-red-600 p-4 rounded-md bg-red-100">Erro de permissão ao carregar. Verifique as regras do Firestore.</p>`;
                });
            }
            
            async function setupInitialAuthScreen() {
                const registerLinkContainer = document.getElementById('register-link-container');
                try {
                    const adminDoc = await getDoc(doc(db, "appConfig", "adminSetup"));
                    registerLinkContainer.style.display = adminDoc.exists() ? 'none' : 'block';
                } catch (e) {
                    console.error("Erro ao verificar setup do admin:", e);
                    registerLinkContainer.style.display = 'block'; 
                }
            }

            async function handleRegisterFormSubmit(e) {
                e.preventDefault();
                try {
                    const adminDoc = await getDoc(doc(db, "appConfig", "adminSetup"));
                    if (adminDoc.exists()) {
                        showAuthAlert('register-error', 'A conta de Admin já foi criada.');
                        return;
                    }
                    await createUserWithEmailAndPassword(auth, e.target['register-email'].value, e.target['register-password'].value);
                } catch (error) {
                    let message = 'Erro ao criar conta.';
                    if (error.code === 'auth/email-already-in-use') message = 'Este e-mail já está em uso.';
                    else if (error.code === 'auth/weak-password') message = 'A senha precisa ter no mínimo 6 caracteres.';
                    showAuthAlert('register-error', message);
                }
            }
            
            async function handleCreateUserFormSubmit(e) {
                e.preventDefault();
                const feedbackEl = document.getElementById('create-user-feedback');
                const email = e.target['new-user-email'].value;
                const password = e.target['new-user-password'].value;
                const role = e.target['new-user-role'].value;
                if (!role) {
                    feedbackEl.textContent = 'Erro: Por favor, selecione uma função.';
                    feedbackEl.className = 'p-3 mb-4 text-sm rounded-lg bg-red-100 text-red-800 block';
                    return;
                }
                feedbackEl.textContent = 'Criando...';
                feedbackEl.className = 'p-3 mb-4 text-sm rounded-lg bg-yellow-100 text-yellow-800 block';
                try {
                    await callHttpsFunction('createUser', { email, password, role }); 
                    feedbackEl.textContent = 'Usuário criado com sucesso!';
                    feedbackEl.className = 'p-3 mb-4 text-sm rounded-lg bg-green-100 text-green-800 block';
                    e.target.reset();
                    setTimeout(() => { 
                        document.getElementById('create-user-modal').classList.remove('flex');
                        feedbackEl.classList.add('hidden');
                    }, 2000);
                } catch (error) {
                    feedbackEl.textContent = `Erro: ${error.message}`;
                    feedbackEl.className = 'p-3 mb-4 text-sm rounded-lg bg-red-100 text-red-800 block';
                }
            }
            
            async function openContractModal(mode = 'add', contractData = {}) {
                const modal = document.getElementById('contract-modal');
                const form = modal.querySelector('#contract-form');
                const fileInput = form.querySelector('#document-files');
                const stagedAttachmentsListDiv = form.querySelector('#staged-attachments-list');
                form.reset();
                fileInput.value = '';
                stagedAttachmentsListDiv.innerHTML = '';
                fileInput.addEventListener('change', renderStagedAttachments);
                const attachmentsListDiv = form.querySelector('#attachments-list');
                const installmentsNumberInput = form.querySelector('#installments-number');
                installmentsNumberInput.addEventListener('change', () => generateInstallmentFields());
                
                if (unsubscribeFromAttachments) unsubscribeFromAttachments();
                if (unsubscribeFromAuditTrail) unsubscribeFromAuditTrail();

                const auditTrailSection = document.getElementById('audit-trail-section');
                auditTrailSection.classList.add('hidden');

                if (mode === 'edit') {
                    modal.querySelector('#modal-title').textContent = 'Gerenciar Contrato';
                    form.querySelector('#contract-id').value = contractData.id;
                    form.querySelector('#title').value = contractData.title || '';
                    form.querySelector('#party').value = contractData.contractedParty || '';
                    form.querySelector('#status').value = contractData.status || 'Proposta Registrada';
                    form.querySelector('#service_type').value = contractData.service_type || '';
                    form.querySelector('#cost_center').value = contractData.costCenter || 'Institucional';
                    form.querySelector('#sector').value = contractData.sector || 'RH';
                    form.querySelector('#start-date').value = contractData.startDate || '';
                    form.querySelector('#end-date').value = contractData.endDate || '';
                    form.querySelector('#value').value = contractData.totalValue || 0;
                    form.querySelector('#observations').value = contractData.observations || '';
                    fileInput.disabled = false;
                    
                    if (contractData.installments && contractData.installments.length > 0) {
                        installmentsNumberInput.value = contractData.installments.length;
                        generateInstallmentFields(contractData.installments);
                    } else {
                        installmentsNumberInput.value = 1;
                        generateInstallmentFields();
                    }
                    
                    attachmentsListDiv.innerHTML = '<p class="text-xs text-gray-500">Carregando anexos...</p>';
                    const attachmentsQuery = query(collection(db, `sharedContracts/${contractData.id}/anexos`), orderBy("uploadedAt", "desc"));
                    unsubscribeFromAttachments = onSnapshot(attachmentsQuery, (snapshot) => {
                        const attachments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderAttachmentsList(attachments, contractData.id);
                    });

                    auditTrailSection.classList.remove('hidden');
                    const auditTrailList = document.getElementById('audit-trail-list');
                    auditTrailList.innerHTML = '<p class="text-xs text-gray-500">Carregando histórico...</p>';
                    const auditTrailQuery = query(collection(db, `sharedContracts/${contractData.id}/auditTrail`), orderBy("timestamp", "desc"));
                    unsubscribeFromAuditTrail = onSnapshot(auditTrailQuery, (snapshot) => {
                        const auditLogs = snapshot.docs.map(doc => doc.data());
                        renderAuditTrail(auditLogs);
                    });

                    const statusSelect = form.querySelector('#status');
                    const modalActionsContainer = form.querySelector('#modal-actions-container');
                    modalActionsContainer.innerHTML = '';
                    statusSelect.disabled = true;
                    
                    const createActionButton = (text, newStatus, colorClass) => {
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.textContent = text;
                        button.className = `px-4 py-2 text-white font-semibold rounded-md ${colorClass}`;
                        button.onclick = () => {
                            showAlert('Confirmar Alteração', `Deseja mesmo alterar o status para "${newStatus}"?`, [
                                { text: 'Cancelar', class: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-md' },
                                { text: 'Confirmar', class: 'px-4 py-2 bg-blue-600 text-white rounded-md', onClick: async () => {
                                    try {
                                        await updateDoc(doc(db, "sharedContracts", contractData.id), { 
                                            status: newStatus, 
                                            lastModifiedAt: serverTimestamp(),
                                            lastModifiedBy: { uid: currentUser.uid, email: currentUser.email }
                                        });
                                        closeContractModal();
                                    } catch (err) {
                                        showAlert('Erro', 'Você não tem permissão para realizar esta ação.', [{ text: 'OK', class: 'px-4 py-2 bg-red-500 text-white rounded-md' }]);
                                    }
                                }}
                            ]);
                        };
                        modalActionsContainer.appendChild(button);
                    };
                    
                    const currentStatus = (contractData.status || '').trim();
                    const currentUserRole = (userRole || '').trim();

                    if (currentUserRole === 'Valida Documentos' && currentStatus === 'Proposta Registrada') {
                        createActionButton('Validar Documentação', 'Documentação Validada', 'bg-cyan-500 hover:bg-cyan-600');
                    }
                    if (currentUserRole === 'Valida Pagamento' && currentStatus === 'Documentação Validada') {
                        createActionButton('Validar Pagamento', 'Pagamento Validado', 'bg-blue-500 hover:bg-blue-600');
                    }
                    if (currentUserRole === 'Valida Assinatura' && currentStatus === 'Pagamento Validado') {
                        createActionButton('Validar para Assinatura', 'Pronta para Assinatura', 'bg-indigo-500 hover:bg-indigo-600');
                    }
                    if (currentUserRole === 'Assina Minuta' && currentStatus === 'Pronta para Assinatura') {
                        createActionButton('Assinar e Concluir', 'Contrato Assinado e Concluído', 'bg-green-500 hover:bg-green-600');
                    }
                    if (currentUserRole === 'admin' || currentUserRole === 'Presidente') {
                        statusSelect.disabled = false;
                    }
                } else { 
                    modal.querySelector('#modal-title').textContent = 'Adicionar Novo Contrato';
                    form.querySelector('#contract-id').value = '';
                    attachmentsListDiv.innerHTML = '';
                    fileInput.disabled = false;
                    installmentsNumberInput.value = 1;
                    generateInstallmentFields();
                    const statusSelect = form.querySelector('#status');
                    const modalActionsContainer = form.querySelector('#modal-actions-container');
                    statusSelect.value = 'Proposta Registrada';
                    statusSelect.disabled = true;
                    modalActionsContainer.innerHTML = '';
                }
                modal.classList.add('flex');
            };

            function closeContractModal() {
                if (unsubscribeFromAttachments) unsubscribeFromAttachments();
                if (unsubscribeFromAuditTrail) unsubscribeFromAuditTrail();
                const fileInput = document.getElementById('document-files');
                fileInput.removeEventListener('change', renderStagedAttachments);
                const installmentsNumberInput = document.getElementById('installments-number');
                installmentsNumberInput.removeEventListener('change', () => generateInstallmentFields());
                document.getElementById('contract-modal').classList.remove('flex');
            }
            
            async function handleContractFormSubmit(e) {
                e.preventDefault();
                const form = e.target;
                const saveBtn = form.querySelector('#save-btn');
                const saveBtnText = form.querySelector('#save-btn-text');
                const saveSpinner = form.querySelector('#save-spinner');
                saveBtn.disabled = true;
                saveBtnText.textContent = 'Salvando...';
                saveSpinner.classList.remove('hidden');
                
                const id = form.querySelector('#contract-id').value;
                const files = form.querySelector('#document-files').files;
                const installmentsContainer = form.querySelector('#installments-container');
                const installmentDates = installmentsContainer.querySelectorAll('.installment-date');
                const installmentValues = installmentsContainer.querySelectorAll('.installment-value');
                const installments = [];
                for (let i = 0; i < installmentDates.length; i++) {
                    installments.push({ date: installmentDates[i].value, value: parseFloat(installmentValues[i].value) || 0 });
                }
                
                const contractData = {
                    title: form.querySelector('#title').value,
                    contractedParty: form.querySelector('#party').value,
                    status: form.querySelector('#status').value,
                    service_type: form.querySelector('#service_type').value,
                    costCenter: form.querySelector('#cost_center').value,
                    sector: form.querySelector('#sector').value,
                    startDate: form.querySelector('#start-date').value,
                    endDate: form.querySelector('#end-date').value,
                    totalValue: parseFloat(form.querySelector('#value').value) || 0,
                    observations: form.querySelector('#observations').value,
                    lastModifiedAt: serverTimestamp(),
                    lastModifiedBy: { uid: currentUser.uid, email: currentUser.email },
                    installments: installments
                };
                
                let currentContractId = id;
                try {
                    if (id) {
                        await updateDoc(doc(db, "sharedContracts", id), contractData);
                    } else {
                        contractData.createdAt = serverTimestamp();
                        contractData.createdBy = { uid: currentUser.uid, email: currentUser.email };
                        const newDocRef = await addDoc(collection(db, "sharedContracts"), contractData);
                        currentContractId = newDocRef.id;
                    }
                    
                    if (files.length > 0 && currentContractId) {
                        saveBtnText.textContent = `Enviando ${files.length} anexo(s)...`;
                        const uploadPromises = Array.from(files).map(file => {
                            return new Promise((resolve, reject) => {
                                const reader = new FileReader();
                                reader.onload = async () => {
                                    try {
                                        const result = await callHttpsFunction('uploadFile', { fileContent: reader.result, fileName: file.name, contractId: currentContractId });
                                        resolve(result);
                                    } catch (error) {
                                        reject(error);
                                    }
                                };
                                reader.onerror = reject;
                                reader.readAsDataURL(file);
                            });
                        });
                        await Promise.all(uploadPromises);
                    }
                    closeContractModal();
                } catch (error) {
                    console.error("Erro ao salvar contrato:", error);
                    showAlert('Erro ao Salvar', `Ocorreu um erro. Você pode não ter permissão para esta ação. Erro: ${error.message}`, [{ text: 'OK', class: 'px-4 py-2 bg-red-500 text-white rounded-md' }]);
                } finally {
                    saveBtn.disabled = false;
                    saveBtnText.textContent = 'Salvar';
                    saveSpinner.classList.add('hidden');
                }
            }
            
            function applyFiltersAndRender() {
                if (!allContracts) return;
                const searchTerm = document.getElementById('search-input').value.toLowerCase();
                const statusFilter = document.getElementById('filter-process-status').value;
                const costCenterFilter = document.getElementById('filter-cost-center').value;
                const sectorFilter = document.getElementById('filter-sector').value;
                
                const filteredContracts = allContracts.filter(contract => {
                    const statusMatch = statusFilter === 'all' || contract.status === statusFilter;
                    const costCenterMatch = costCenterFilter === 'all' || contract.costCenter === costCenterFilter;
                    const sectorMatch = sectorFilter === 'all' || contract.sector === sectorFilter;
                    const searchMatch = !searchTerm || 
                                        (contract.title && contract.title.toLowerCase().includes(searchTerm)) || 
                                        (contract.contractedParty && contract.contractedParty.toLowerCase().includes(searchTerm));
                    return statusMatch && costCenterMatch && sectorMatch && searchMatch;
                });
                renderContracts(filteredContracts);
            };

            function renderContracts(contracts) {
                const contractGrid = document.getElementById('contract-grid');
                contractGrid.innerHTML = '';
                if (contracts.length === 0 && appListenersInitialized) {
                    document.getElementById('loading-message').innerHTML = `<div class="text-center col-span-full py-10"><i class="fas fa-folder-open fa-3x text-gray-400 mb-4"></i><p class="text-gray-500 text-lg">Nenhum contrato encontrado.</p></div>`;
                } else {
                    contracts.forEach(contract => {
                        contractGrid.appendChild(createContractCard(contract));
                    });
                }
            }

            function createContractCard(contract) {
                const card = document.createElement('div');
                card.className = 'bg-white p-5 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-300 flex flex-col justify-between';
                
                const processStatus = contract.status || 'Proposta Registrada';
                const processStyle = PROCESS_STATUS_STYLES[processStatus] || PROCESS_STATUS_STYLES['Proposta Registrada'];
                const formattedValue = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(contract.totalValue || 0);
                const formattedStartDate = contract.startDate ? new Date(contract.startDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                const formattedEndDate = contract.endDate ? new Date(contract.endDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                const observationsHTML = contract.observations ? `<p class="mt-3 pt-3 border-t border-gray-100 text-sm text-gray-700 whitespace-pre-wrap"><i class="fas fa-comment-dots w-5 mr-1 text-gray-400"></i>${contract.observations}</p>` : '';

                let installmentsHTML = '';
                if (contract.installments && contract.installments.length > 1) {
                     installmentsHTML = `
                         <div class="mt-4 pt-4 border-t border-gray-100">
                             <h4 class="text-sm font-semibold text-gray-600 mb-2">
                                 <i class="fas fa-cash-register mr-1 text-gray-400"></i>Parcelamento:
                             </h4>
                             <div class="space-y-2 text-xs">
                                 ${contract.installments.map((inst, index) => `
                                     <div class="flex justify-between items-center">
                                         <span>Parcela ${index + 1}:</span>
                                         <span class="font-semibold">${inst.date ? new Date(inst.date + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A'} - ${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(inst.value)}</span>
                                     </div>
                                 `).join('')}
                             </div>
                         </div>
                     `;
                }

                // *** ALTERAÇÃO AQUI: Cria a seção de anexos para o card ***
                let attachmentsHTML = '';
                if (contract.attachments && contract.attachments.length > 0) {
                     attachmentsHTML = `
                         <div class="mt-4 pt-4 border-t border-gray-100">
                             <h4 class="text-sm font-semibold text-gray-600 mb-2">
                                 <i class="fas fa-paperclip mr-1 text-gray-400"></i>Anexos:
                             </h4>
                             <div class="space-y-2">
                                 ${contract.attachments.map(att => `
                                     <a href="${att.documentURL}" target="_blank" rel="noopener noreferrer" class="flex items-center text-blue-600 hover:underline text-sm p-1 rounded-md hover:bg-blue-50 transition-colors duration-200">
                                         <i class="fas fa-file-pdf w-5 mr-2 text-red-500"></i>
                                         <span class="truncate" title="${att.documentName}">${att.documentName}</span>
                                     </a>
                                 `).join('')}
                             </div>
                         </div>
                     `;
                }

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-bold text-gray-800 pr-2">${contract.title}</h3>
                            <span class="text-xs font-semibold px-2.5 py-1 rounded-full bg-${processStyle.color}-100 text-${processStyle.color}-800 whitespace-nowrap">
                                <i class="fas ${processStyle.icon} mr-1"></i> ${processStatus}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">com <strong>${contract.contractedParty}</strong></p>
                        <div class="space-y-3 text-sm text-gray-700">
                            <p><i class="fas fa-briefcase w-5 mr-1 text-gray-400"></i>Tipo: <strong>${contract.service_type || 'N/A'}</strong></p>
                            <p><i class="fas fa-building w-5 mr-1 text-gray-400"></i>Setor: <strong>${contract.sector || 'N/A'}</strong></p>
                            <p><i class="fas fa-dollar-sign w-5 mr-1 text-gray-400"></i>C. Custo: <strong>${contract.costCenter || 'N/A'}</strong></p>
                            <p><i class="fas fa-calendar-alt w-5 mr-1 text-gray-400"></i>Vigência: ${formattedStartDate} a ${formattedEndDate}</p>
                            <p><i class="fas fa-coins w-5 mr-1 text-gray-400"></i>Valor: ${formattedValue}</p>
                        </div>
                        ${observationsHTML}
                        ${installmentsHTML}
                        ${attachmentsHTML} 
                    </div>
                `;
                
                const actionsContainer = document.createElement('div');
                actionsContainer.className = 'flex justify-end space-x-3 mt-5 pt-4 border-t border-gray-100';

                const currentStatus = (contract.status || '').trim();
                const currentUserRole = (userRole || '').trim();

                const canManage = currentUserRole === 'admin' || 
                                  currentUserRole === 'Presidente' ||
                                  (currentUserRole === 'Registra Proposta' && currentStatus === 'Proposta Registrada') ||
                                  (currentUserRole === 'Valida Documentos' && currentStatus === 'Proposta Registrada') ||
                                  (currentUserRole === 'Valida Pagamento' && currentStatus === 'Documentação Validada') ||
                                  (currentUserRole === 'Valida Assinatura' && currentStatus === 'Pagamento Validado') ||
                                  (currentUserRole === 'Assina Minuta' && currentStatus === 'Pronta para Assinatura');
                                  
                if (canManage) {
                    const editButton = document.createElement('button');
                    editButton.innerHTML = `<i class="fas fa-pencil-alt mr-1"></i>Gerenciar / Avançar`;
                    editButton.className = "text-gray-500 hover:text-blue-600 transition-colors text-sm font-medium";
                    editButton.onclick = () => openContractModal('edit', contract);
                    actionsContainer.appendChild(editButton);
                }

                if (currentUserRole === 'admin' || currentUserRole === 'Presidente') {
                    const deleteButton = document.createElement('button');
                    deleteButton.innerHTML = `<i class="fas fa-trash-alt mr-1"></i>Deletar`;
                    deleteButton.className = "text-gray-500 hover:text-red-600 transition-colors text-sm font-medium";
                    deleteButton.onclick = () => deleteContract(contract);
                    actionsContainer.appendChild(deleteButton);
                }
                
                card.appendChild(actionsContainer);
                return card;
            }
            
            function generateInstallmentFields(existingInstallments = []) {
                const container = document.getElementById('installments-container');
                const number = document.getElementById('installments-number').valueAsNumber || 1;
                container.innerHTML = '';
                if (number > 1) { 
                    const title = document.createElement('h4');
                    title.className = 'text-md font-semibold text-gray-700 border-t pt-4 md:col-span-2';
                    title.textContent = 'Detalhes das Parcelas';
                    container.appendChild(title);
                    for (let i = 0; i < number; i++) {
                        const installmentData = existingInstallments[i] || {};
                        const fieldSet = document.createElement('div');
                        fieldSet.className = 'grid grid-cols-2 gap-4 p-3 bg-gray-50 rounded-md border md:col-span-2';
                        fieldSet.innerHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Data Parcela ${i + 1}</label>
                                <input type="date" class="installment-date w-full px-3 py-2 border border-gray-300 rounded-md" value="${installmentData.date || ''}" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-600 mb-1">Valor Parcela ${i + 1} (R$)</label>
                                <input type="number" step="0.01" class="installment-value w-full px-3 py-2 border border-gray-300 rounded-md" value="${installmentData.value || ''}" required>
                            </div>
                        `;
                        container.appendChild(fieldSet);
                    }
                }
            }

            function renderStagedAttachments() {
                const fileInput = document.getElementById('document-files');
                const stagedListDiv = document.getElementById('staged-attachments-list');
                const files = fileInput.files;
                stagedListDiv.innerHTML = '';
                if (files.length > 0) {
                    const titleEl = document.createElement('p');
                    titleEl.className = 'text-xs font-semibold text-gray-500 mt-3 border-t pt-3';
                    titleEl.textContent = files.length > 1 ? 'Arquivos a serem enviados:' : 'Arquivo a ser enviado:';
                    stagedListDiv.appendChild(titleEl);
                }
                Array.from(files).forEach(file => {
                    const stagedFileHTML = `
                        <div class="flex items-center justify-between bg-yellow-50 p-2 rounded-md border border-yellow-200">
                            <div class="flex items-center text-sm truncate pr-2 text-yellow-800">
                                <i class="fas fa-arrow-up-from-bracket mr-2"></i>
                                <span class="truncate" title="${file.name}">${file.name}</span>
                            </div>
                        </div>
                    `;
                    stagedListDiv.insertAdjacentHTML('beforeend', stagedFileHTML);
                });
            }
            
            function renderAttachmentsList(attachments, contractId) {
                const attachmentsListDiv = document.getElementById('attachments-list');
                if (!attachments || attachments.length === 0) {
                    attachmentsListDiv.innerHTML = '<p class="text-xs text-gray-500">Nenhum anexo salvo.</p>';
                    return;
                }
                attachmentsListDiv.innerHTML = attachments.map(att => `
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-md">
                        <a href="${att.documentURL}" target="_blank" class="text-blue-600 hover:underline text-sm truncate pr-2" title="${att.documentName}">
                            <i class="fas fa-file-pdf mr-1 text-red-500"></i>
                            ${att.documentName}
                        </a>
                        <button type="button" data-contract-id="${contractId}" data-attachment-id="${att.id}" data-storage-path="${att.storagePath}" data-document-name="${att.documentName}" class="attachment-delete-btn text-gray-400 hover:text-red-600 transition-colors">
                            <i class="fas fa-times-circle"></i>
                        </button>
                    </div>
                `).join('');
                attachmentsListDiv.querySelectorAll('.attachment-delete-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const { contractId, attachmentId, storagePath, documentName } = e.currentTarget.dataset;
                        handleDeleteAttachment(contractId, attachmentId, storagePath, documentName);
                    });
                });
            }
            
            async function handleDeleteAttachment(contractId, attachmentId, storagePath, documentName) {
                showAlert('Confirmar Deleção de Anexo', `Deletar o arquivo "${documentName}"? Esta ação não pode ser desfeita.`, [
                    { text: 'Cancelar', class: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-md' },
                    { text: 'Deletar Anexo', class: 'px-4 py-2 bg-red-600 text-white rounded-md', onClick: async () => {
                        try {
                            await callHttpsFunction('deleteFile', { contractId, attachmentId, storagePath, fileName: documentName });
                        } catch (error) {
                            showAlert('Erro', `Não foi possível deletar o anexo: ${error.message}`, [{ text: 'OK', class: 'px-4 py-2 bg-red-500 text-white rounded-md' }]);
                        }
                    }}
                ]);
            }

            function deleteContract(contract) {
                showAlert('Confirmar Deleção', `Deletar o contrato "${contract.title}"? Esta ação irá ARQUIVAR todo o histórico e então apagar o registro. A ação não pode ser desfeita.`, [
                    { text: 'Cancelar', class: 'px-4 py-2 bg-gray-200 text-gray-700 rounded-md' },
                    { text: 'Deletar e Arquivar', class: 'px-4 py-2 bg-red-600 text-white rounded-md', onClick: async () => {
                        try {
                            await callHttpsFunction('deleteContractAndLog', { contractId: contract.id });
                            showAlert('Sucesso', 'O contrato foi deletado e arquivado com sucesso.', [{ text: 'OK', class: 'px-4 py-2 bg-blue-500 text-white rounded-md' }]);
                        } catch (error) {
                            showAlert('Erro', `Não foi possível deletar o contrato: ${error.message}`, [{ text: 'OK', class: 'px-4 py-2 bg-red-500 text-white rounded-md' }]);
                        }
                    }}
                ]);
            }

            function renderAuditTrail(logs) {
                const listEl = document.getElementById('audit-trail-list');
                if (!logs || logs.length === 0) {
                    listEl.innerHTML = '<p class="text-sm text-gray-500">Nenhum histórico de alterações encontrado.</p>';
                    return;
                }
                listEl.innerHTML = logs.map(log => {
                    const timestamp = log.timestamp ? log.timestamp.toDate() : new Date();
                    const formattedDate = timestamp.toLocaleDateString('pt-BR');
                    const formattedTime = timestamp.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });

                    return `
                        <div class="flex items-start text-sm">
                            <div class="mr-3 text-center flex-shrink-0">
                                <i class="fas fa-history text-gray-400"></i>
                            </div>
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-700">${log.action}</p>
                                <p class="text-gray-600">${log.details}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Por: ${log.user.email} em ${formattedDate} às ${formattedTime}
                                </p>
                            </div>
                        </div>
                    `;
                }).join('<hr class="my-2 border-gray-200">');
            }

            function generatePDFReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'landscape' });
                const tableColumn = ["Título", "Parte Contratada", "Status", "Tipo de Serviço", "C. Custo", "Setor", "Início", "Término", "Valor (R$)", "Observações"];
                const tableRows = [];
                
                const filteredContracts = allContracts.filter(contract => {
                    const statusMatch = document.getElementById('filter-process-status').value === 'all' || contract.status === document.getElementById('filter-process-status').value;
                    const costCenterMatch = document.getElementById('filter-cost-center').value === 'all' || contract.costCenter === document.getElementById('filter-cost-center').value;
                    const sectorMatch = document.getElementById('filter-sector').value === 'all' || contract.sector === document.getElementById('filter-sector').value;
                    const searchTerm = document.getElementById('search-input').value.toLowerCase();
                    const searchMatch = !searchTerm || (contract.title && contract.title.toLowerCase().includes(searchTerm)) || (contract.contractedParty && contract.contractedParty.toLowerCase().includes(searchTerm));
                    return statusMatch && costCenterMatch && sectorMatch && searchMatch;
                });
                
                filteredContracts.forEach(contract => {
                    tableRows.push([
                        contract.title, contract.contractedParty, contract.status || 'N/A',
                        contract.service_type || '', contract.costCenter || '', contract.sector || '',
                        contract.startDate ? new Date(contract.startDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A',
                        contract.endDate ? new Date(contract.endDate + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A',
                        new Intl.NumberFormat('pt-BR').format(contract.totalValue || 0),
                        contract.observations || ''
                    ]);
                });
                
                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 20, theme: 'grid', styles: { fontSize: 8 }, headStyles: { fillColor: [22, 160, 133] } });
                doc.save("relatorio-contratos.pdf");
            }
            
            setupAuthListeners();

        }); 
    </script>
</body>
</html>
